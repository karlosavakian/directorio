{% extends 'base.html' %}
{% block body_class %}club-profile-page{% endblock %}

{% load static %}

{% block content %}
<div class="container-fluid col-12 px-3 my-3" id="profile-container">
  <!-- Flecha volver arriba -->
  {% include 'partials/_back-btn.html' %}

  <div class="row">

    <!-- Columna Izquierda: Info del Club -->
    <div class="col-lg-2  ">
          {% if club.logo %}
        <img src="{{ club.logo.url }}" alt="{{ club.name }}" >
      {% endif %}
    <div class="d-flex align-items-start mt-4 mb-4 gap-3 ">
       <div>
        
     <h1 class="h3 mb-0" style="font-weight:900;">{{ club.name }}</h1>

    <div class="d-flex align-items-center mb-3">
        <span class="badge bg-secondary">{{ club.get_category_display }}</span>
        {% if club.verified %}
        <span class="ms-2" title="Verificado">
            <!-- Tu SVG -->
            <svg fill="none" height="24" viewBox="0 0 24 24" width="15" xmlns="http://www.w3.org/2000/svg">
                <path clip-rule="evenodd" d="M1 12C1 5.92487 5.92487 1 12 1C18.0751 1 23 5.92487 23 12C23 18.0751 18.0751 23 12 23C5.92487 23 1 18.0751 1 12ZM11.2071 16.2071L18.2071 9.20711L16.7929 7.79289L10.5 14.0858L7.20711 10.7929L5.79289 12.2071L9.79289 16.2071C9.98043 16.3946 10.2348 16.5 10.5 16.5C10.7652 16.5 11.0196 16.3946 11.2071 16.2071Z" fill="black" fill-rule="evenodd"/>
            </svg>
        </span>
        {% endif %}
    </div>
    
    <p class="mb-1 small d-flex align-items-center">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
       stroke-linecap="round" stroke-linejoin="round" class="me-2" viewBox="0 0 24 24">
    <path d="M21 10c0 6-9 12-9 12S3 16 3 10a9 9 0 0118 0z"/>
    <circle cx="12" cy="10" r="3"/>
  </svg>
  <a href="https://www.google.com/maps/search/?api=1&query={{ club.address|urlencode }}" 
     target="_blank" class="text-decoration-none text-reset">
    {{ club.city }} - {{ club.address }}
  </a>
</p>

<p class="mb-1 small d-flex align-items-center">
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
       stroke-linecap="round" stroke-linejoin="round" class="me-2" viewBox="0 0 24 24">
    <path d="M22 16.92V21a2 2 0 01-2.18 2A19.86 19.86 0 013 5.18 2 2 0 015 3h4.09a2 2 0 012 1.72c.12.81.37 1.6.73 2.33a2 2 0 01-.45 2.11L9.91 10.09a16 16 0 006 6l1.93-1.93a2 2 0 012.11-.45c.73.36 1.52.61 2.33.73a2 2 0 011.72 2z"/>
  </svg>
  <a href="tel:{{ club.phone }}" class="text-decoration-none text-reset">
    {{ club.phone }}
  </a>
</p>
      <p class="mb-1 small d-flex align-items-center">
        {% if club.whatsapp_link %}
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2" viewBox="0 0 24 24">
            <path d="M21.05 16.86a9.88 9.88 0 001.41-5.09 10 10 0 10-18.36 5.9L2 22l4.39-1.48a10 10 0 0014.66-3.66z"/>
            <path d="M8 9c.6 1.1 1.6 2.6 3 3.5s2.4 1.1 2.9 1.2"/>
          </svg>
          <a href="{{ club.whatsapp_link }}" target="_blank" class="text-decoration-none text-reset">WhatsApp</a>
        {% endif %}
      </p>

<p class="mb-1 small d-flex align-items-center">
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor"
       stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2" viewBox="0 0 24 24">
    <path d="M4 4h16c1.1 0 2 .9 2 2v12a2 2 0 0 1-2 2H4c-1.1 0-2-.9-2-2V6a2 2 0 0 1 2-2z" />
    <polyline points="22,6 12,13 2,6" />
  </svg>
  <a href="mailto:{{ club.email }}" class="text-decoration-none text-reset">
    {{ club.email }}
  </a>
</p>

    </div>
    </div>
 
      <div class="d-flex flex-wrap gap-4 justify-content-start">
        {% for feature in club.features.all %}
          <div class="d-flex flex-column align-items-center text-center" style="width:4rem;">
            {% if feature.icon %}
              <img src="{{ feature.icon.url }}" alt="{{ feature.name }}" style="width:20px; height:20px;">
            {% endif %}
            <div class="fw-medium d-flex align-items-center justify-content-center text-wrap mt-2" style="height: 2.5rem; font-size:12px;">
              {{ feature.name }}
            </div>
          </div>
        {% endfor %}
      </div>

    </div>

    <!-- Columna Central: Galería y Features -->
    <div class="col-lg-8">
      <div class="mb-4   rounded">
        {% if club.photos.all %}
     
  <div class="mb-4 gallery-slideshow">
     <div class="gallery-actions"> 
      <button id="club-heart"
        aria-label="Seguir"
        data-url="{% url 'toggle_follow' 'club' club.id %}"
        class="{% if club_followed %}liked{% endif %}">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path fill-rule="evenodd" clip-rule="evenodd" d="M12 6.00019C10.2006 3.90317 7.19377 3.2551 4.93923 5.17534C2.68468 7.09558 2.36727 10.3061 4.13778 12.5772C5.60984 14.4654 10.0648 18.4479 11.5249 19.7369C11.6882 19.8811 11.7699 19.9532 11.8652 19.9815C11.9483 20.0062 12.0393 20.0062 12.1225 19.9815C12.2178 19.9532 12.2994 19.8811 12.4628 19.7369C13.9229 18.4479 18.3778 14.4654 19.8499 12.5772C21.6204 10.3061 21.3417 7.07538 19.0484 5.17534C16.7551 3.2753 13.7994 3.90317 12 6.00019Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
      </button>

 
      <button id="club-share" aria-label="Compartir">
       <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M8.68439 10.6578L15.3124 7.34378M15.3156 16.6578L8.69379 13.3469M21 6C21 7.65685 19.6569 9 18 9C16.3431 9 15 7.65685 15 6C15 4.34315 16.3431 3 18 3C19.6569 3 21 4.34315 21 6ZM9 12C9 13.6569 7.65685 15 6 15C4.34315 15 3 13.6569 3 12C3 10.3431 4.34315 9 6 9C7.65685 9 9 10.3431 9 12ZM21 18C21 19.6569 19.6569 21 18 21C16.3431 21 15 19.6569 15 18C15 16.3431 16.3431 15 18 15C19.6569 15 21 16.3431 21 18Z" stroke="#000000" stroke-width="1.5"></path> </g></svg>
      </button>
    </div>
    {% for photo in club.photos.all %}
      <div class="gallery-slide{% if forloop.first %} active{% endif %}">
        <img src="{{ photo.image.url }}" alt="Foto" class="img-fluid rounded shadow-sm" style="width:100%; max-height:450px; object-fit:contain; background:rgb(85, 85, 85);">
      </div>
    {% endfor %}
    <button id="galleryPrev" class="slide-arrow left">
      <svg viewBox="0 0 48 48"><path d="M30.83 32.67l-9.17-9.17 9.17-9.17-2.83-2.83-12 12 12 12z"/><path d="M0-.5h48v48h-48z" fill="none"/></svg>
    </button>
    <button id="galleryNext" class="slide-arrow right">
      <svg viewBox="0 0 48 48" style="transform:rotate(180deg);"><path d="M30.83 32.67l-9.17-9.17 9.17-9.17-2.83-2.83-12 12 12 12z"/><path d="M0-.5h48v48h-48z" fill="none"/></svg>
    </button>
  </div>
  <div class="gallery-dots">
    {% for photo in club.photos.all %}
      <span class="gallery-dot{% if forloop.first %} active{% endif %}"></span>
    {% endfor %}
  </div>
        {% else %}
          <p>No hay fotos todavía.</p>
        {% endif %}
      </div>
<!-- Menú de pestañas -->
<ul class="nav custom-tab-menu mb-3 border-bottom justify-content-center" id="clubTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="about-tab" data-bs-toggle="tab" data-bs-target="#about" type="button" role="tab">Sobre el club</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button" role="tab">Horarios</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="posts-tab" data-bs-toggle="tab" data-bs-target="#posts" type="button" role="tab">Publicaciones</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="competitors-tab" data-bs-toggle="tab" data-bs-target="#competitors" type="button" role="tab">Competidores</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments" type="button" role="tab">Valoraciones</button>
  </li>
</ul>


<!-- Contenido de pestañas -->
<div class="tab-content" id="clubTabsContent">
  <!-- About -->
  <div class="tab-pane fade show active" id="about" role="tabpanel">
    <div class="row p-3">
      <div class="col-lg-7">
         <div class="col-12">

          <p>{{ club.about|linebreaks }}</p>
         </div>

        {% if club.entrenadores.all %}
        <h5 class="mt-4 mb-4">Entrenadores</h5>
        <div class="row">
          {% for e in club.entrenadores.all %}
          <div class="col-6 d-flex align-items-center mb-3">
            {% if e.avatar %}
            <img src="{{ e.avatar.url }}" alt="{{ e.nombre }}" class="rounded-circle me-2" style="width:60px;height:60px;object-fit:cover;">
            {% else %}
            <div class="rounded-circle bg-secondary text-white d-flex justify-content-center align-items-center me-2" style="width:60px;height:50px;">
              {{ e.nombre|first|upper }}
            </div>
            {% endif %}
            <div>{{ e.nombre }} {{ e.apellidos }}</div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      <div class="col-lg-5 p-2">
        <a href="https://www.google.com/maps/search/?api=1&query={{ club.address|urlencode }}" target="_blank">
          <iframe src="https://maps.google.com/maps?q={{ club.address|urlencode }}&output=embed" width="100%" height="250" style="border:0;" loading="lazy" allowfullscreen></iframe>
        </a>
      </div>
    </div>
  </div>

  <!-- Horarios -->
  <div class="tab-pane fade" id="schedule" role="tabpanel">
    <div class="table-responsive mt-3">
      <table class="table table-bordered text-center align-middle mb-0" style="min-width: 700px;">
        <thead class="table-dark">
          <tr>
            {% for dia, nombre in club.horarios.model.DiasSemana.choices %}
              <th scope="col">{{ nombre }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <tr>
            {% for dia, nombre in club.horarios.model.DiasSemana.choices %}
              <td>
                {% with horarios_dia=club.horarios.all|dictsort:"hora_inicio" %}
                  {% for h in horarios_dia %}
                    {% if h.dia == dia %}
                      <div class="border-bottom py-1 small text-muted">
                        {{ h.hora_inicio|time:"H:i" }} - {{ h.hora_fin|time:"H:i" }}
                      </div>
                    {% endif %}
                  {% empty %}
                    <span class="text-muted">—</span>
                  {% endfor %}
                {% endwith %}
              </td>
            {% endfor %}
          </tr>
        </tbody>
      </table>
    </div>
    {% if club.clases.all %}
    <div class="mt-4">
      <h5>Clases</h5>
      <ul class="list-group">
        {% for c in club.clases.all %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>{{ c.nombre }} ({{ c.hora_inicio|time:"H:i" }} - {{ c.hora_fin|time:"H:i" }})</span>
            {% if user.is_authenticated %}
            <form action="{% url 'book_clase' c.id %}" method="post" class="ms-2">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-primary">Reservar</button>
            </form>
            {% else %}
            <button type="button" class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#signupModal">Reservar</button>

            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>

  <!-- Posts -->
  <div class="tab-pane fade" id="posts" role="tabpanel">
    {% for post in posts %}
      <div class="mb-3 border rounded p-3">
        <h5 class="mb-1">{{ post.titulo }}</h5>
        <p class="mb-1">{{ post.contenido }}</p>
        {% if post.evento_fecha %}
          <p class="mb-1"><strong>Evento:</strong> {{ post.evento_fecha }}</p>
        {% endif %}
        <small class="text-muted">{{ post.created_at }}</small>
        {% if user.is_authenticated %}
          <div class="mt-2">
            <a href="{% url 'clubpost_update' post.pk %}" class="btn btn-sm btn-outline-secondary">Editar</a>
            <a href="{% url 'clubpost_delete' post.pk %}" class="btn btn-sm btn-outline-danger">Eliminar</a>
          </div>
        {% endif %}
      </div>
    {% empty %}
      <p>No hay publicaciones.</p>
    {% endfor %}
    {% if user.is_authenticated %}
      <a href="{% url 'clubpost_create' club.slug %}" class="btn btn-primary mt-3">Crear publicación</a>
    {% endif %}
  </div>

  <!-- Competidores -->
  <div class="tab-pane fade" id="competitors">
  {% if competidores %}
    <div class="table-responsive mt-3">
      <table class="table table-sm table-striped table-bordered text-center">
        <thead class="table-dark">
          <tr>
            <th>Nombre</th>
            <th>Victorias</th>
            <th>Derrotas</th>
            <th>Empates</th>
            <th>Títulos</th>
          </tr>
        </thead>
        <tbody>
          {% for competidor in competidores %}
            <tr>
              <td>{{ competidor.nombre }}</td>
              <td style="color:#008800;">{{ competidor.victorias }}</td>
              <td style="color:#c60300;">{{ competidor.derrotas }}</td>
              <td style="color:#7faefc;">{{ competidor.empates }}</td>
              <td>{{ competidor.titulos|default:"—" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="mt-3 text-muted">Este club aún no tiene competidores registrados.</p>
  {% endif %}
</div> 


  <!-- Comentarios -->
<div class="tab-pane fade" id="comments">
  <div class="row py-3">
    <div class="col-lg-6 mb-4">
      {% if user.is_authenticated %}
        {% if not reseña_existente %}
          <form method="POST" id="reseña-form">
            {% csrf_token %}
            {% if form.errors %}
            <div class="alert alert-danger">Por favor completa todos los campos obligatorios.</div>
            {% endif %}
            <div class="mb-3">
              <label class="form-label">Instalaciones:</label>
              <div class="star-rating" data-name="instalaciones"></div>
              <input type="hidden" name="instalaciones" required id="input-instalaciones">
            </div>
            <div class="mb-3">
              <label class="form-label">Entrenadores:</label>
              <div class="star-rating" data-name="entrenadores"></div>
              <input type="hidden" name="entrenadores" required id="input-entrenadores">
            </div>
            <div class="mb-3">
              <label class="form-label">Ambiente:</label>
              <div class="star-rating" data-name="ambiente"></div>
              <input type="hidden" name="ambiente" required id="input-ambiente">
            </div>
            <div class="mb-3">
              <label class="form-label">Calidad-precio:</label>
              <div class="star-rating" data-name="calidad_precio"></div>
              <input type="hidden" name="calidad_precio" required id="input-calidad_precio">
            </div>
            <div class="mb-3">
              <label class="form-label">Variedad de clases:</label>
              <div class="star-rating" data-name="variedad_clases"></div>
              <input type="hidden" name="variedad_clases" required id="input-variedad_clases">
            </div>
            <div class="mb-3">
              <textarea name="comentario" class="form-control" rows="4" minlength="200" placeholder="¿Qué te ha gustado o qué mejorarías del club?"></textarea>
            </div>
            <button type="submit" class="btn btn-dark">Enviar Reseña</button>
          </form>
          <div id="mensaje-gracias" class="alert alert-success mt-3" style="display:none;">
            Gracias por valorar el club. Tu reseña será publicada en breve.
          </div>
        {% else %}
          <!-- <p>Ya has dejado una reseña para este club.</p> -->
        {% endif %}
      {% else %}
        <!-- <p><a href="{% url 'login' %}">Inicia sesión</a> para dejar tu reseña.</p> -->
      {% endif %}
    </div>
    <div class="col-lg-6">
      <div class="d-flex justify-content-end mb-3">
        {% include 'partials/_review-filter.html' with orden=orden club=club %}
      </div>
      <div id="review-list">
        {% include 'clubs/reviews_list.html' %}
      </div>
    </div>
  </div>
</div>


</div>



      

    </div>

    <!-- Columna Derecha: Valoraciones y Reseñas -->
    <div class="col-lg-2">
      

      <!-- Carrusel de reseñas -->
      {% if reseñas %}
        <div class="club-reviews">

          <div class="review-carousel" id="review-carousel" onmouseenter="pauseAutoplay()" onmouseleave="startAutoplay()">
            {% for reseña in reseñas %}
              <div class="review-slide{% if forloop.first %} active{% endif %}">
      <p class="review-text">“{{ reseña.comentario }}”</p>

        <div class="review-user-container d-flex align-items-center">
          {% if reseña.usuario.profile.avatar %}
          <img src="{{ reseña.usuario.profile.avatar.url }}" alt="{{ reseña.usuario.username }}" class="review-avatar-img rounded-circle">
          {% else %}
          <div class="review-avatar">{{ reseña.usuario.username|first|upper }}</div>
          {% endif %}
          <div class="fw-medium ms-2">{{ reseña.usuario.username }}</div>
        </div>
    </div>


            {% endfor %}

            <!-- Arrows -->
            <button id="prevBtn" class="review-arrow left" onclick="changeSlide(-1)">
              <svg viewBox="0 0 48 48" width="20" height="20">
                <path d="M30.83 32.67l-9.17-9.17 9.17-9.17-2.83-2.83-12 12 12 12z"/>
                <path d="M0-.5h48v48h-48z" fill="none"/>
              </svg>
            </button>
            <button id="nextBtn" class="review-arrow right" onclick="changeSlide(1)">
              <svg viewBox="0 0 48 48" width="20" height="20" style="transform: rotate(180deg);">
                <path d="M30.83 32.67l-9.17-9.17 9.17-9.17-2.83-2.83-12 12 12 12z"/>
                <path d="M0-.5h48v48h-48z" fill="none"/>
              </svg>
            </button>


          </div>

            <ul class="list-group mb-3 my-5">
                <p class="fw-bold">Nota media: {{ club.average_rating }} / 5 ⭐ <span class="small" style="font-weight:300;"> ({{ club.reviews_count }})</span></p>

                <li class="list-group-item">🏋 Instalaciones: {{ detallado.instalaciones|floatformat:1 }}/5</li>
                <li class="list-group-item">🥊 Entrenadores: {{ detallado.entrenadores|floatformat:1 }}/5</li>
                <li class="list-group-item">🧑‍🤝‍🧑 Ambiente: {{ detallado.ambiente|floatformat:1 }}/5</li>
                <li class="list-group-item">💰 Calidad/precio: {{ detallado.calidad_precio|floatformat:1 }}/5</li>
                <li class="list-group-item">📆 Variedad de clases: {{ detallado.variedad_clases|floatformat:1 }}/5</li>
            </ul>
        </div>
      {% else %}
        <p class="mt-4">Este club aún no tiene reseñas.</p>
      {% endif %}
    </div>
  </div>
</div>
{% include 'partials/_register_modal.html' %}
<script src="{% static 'js/review-filter.js' %}"></script>
<script src="{% static 'js/slides.js' %}"></script>
<script src="{% static 'js/rating.js' %}"></script>

<script src="{% static 'js/share-like.js' %}"></script>

<script src="{% static 'js/gallery-slideshow.js' %}"></script>
{% endblock %}